@model FarewellMyBeloved.ViewModels.AdminEditFarewellPersonViewModel
@{
    ViewData["Title"] = $"Edit {Model.FarewellPerson.Name} - Admin";
}

<style>
    .portrait-preview-container,
    .background-preview-container {
        overflow: hidden;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background-color: #f8f9fa;
    }
    
    .portrait-preview,
    .background-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
    }
</style>

<div class="container py-5">
    <div class="row py-3">
        <div class="col-lg-12">
            <h2 class="mb-4">Edit Farewell Person</h2>
            
            <div class="row">
                <div class="col-lg-8">
                    <form asp-action="EditFarewellPerson" method="post">
                        @Html.AntiForgeryToken()
                        
                        <input type="hidden" asp-for="FarewellPerson.Id" />
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Basic Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="FarewellPerson.Name" class="form-label"></label>
                                        <input asp-for="FarewellPerson.Name" class="form-control" />
                                        <span asp-validation-for="FarewellPerson.Name" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="FarewellPerson.Slug" class="form-label"></label>
                                        <input asp-for="FarewellPerson.Slug" class="form-control" />
                                        <span asp-validation-for="FarewellPerson.Slug" class="text-danger"></span>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="FarewellPerson.Email" class="form-label"></label>
                                        <input asp-for="FarewellPerson.Email" class="form-control" />
                                        <span asp-validation-for="FarewellPerson.Email" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Status</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" asp-for="FarewellPerson.IsPublic">
                                            <label class="form-check-label" asp-for="FarewellPerson.IsPublic">
                                                @(Model.FarewellPerson.IsPublic ? "Public" : "Private")
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label asp-for="FarewellPerson.Description" class="form-label"></label>
                                    <textarea asp-for="FarewellPerson.Description" class="form-control" rows="4"></textarea>
                                    <span asp-validation-for="FarewellPerson.Description" class="text-danger"></span>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="FarewellPerson.PortraitUrl" class="form-label"></label>
                                        <input asp-for="FarewellPerson.PortraitUrl" class="form-control" placeholder="use &ldquo;DELETED BY ADMIN&ldquo; to remove img"/>
                                        <span asp-validation-for="FarewellPerson.PortraitUrl" class="text-danger"></span>
                                        
                                        @if ((!string.IsNullOrEmpty(Model.PortraitImageUrl)) )
                                        {
                                            <div class="mt-2">
                                                <label class="form-label small text-muted w-100">Preview:</label>
                                                <div class="portrait-preview-container d-flex justify-content-center">
                                                    <img src="@Model.PortraitImageUrl"
                                                         alt="Current Portrait"
                                                         class="img-thumbnail portrait-preview"
                                                         onerror="this.src='@Model.FarewellPerson.PortraitUrl'; this.onerror=null;" />
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="FarewellPerson.BackgroundUrl" class="form-label"></label>
                                        <input asp-for="FarewellPerson.BackgroundUrl" class="form-control" placeholder="use &ldquo;DELETED BY ADMIN&ldquo; to remove img" />
                                        <span asp-validation-for="FarewellPerson.BackgroundUrl" class="text-danger"></span>

                                        @if (!string.IsNullOrEmpty(Model.BackgroundImageUrl) )
                                        {
                                            <div class="mt-2">
                                                <label class="form-label small text-muted">Preview:</label>
                                                <div class="background-preview-container">
                                                    <img src="@Model.BackgroundImageUrl"
                                                         alt="Current Background"
                                                         class="img-thumbnail background-preview"
                                                         onerror="this.src='@Model.FarewellPerson.BackgroundUrl'; this.onerror=null;" />
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Content Report Linking</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="FarewellPerson.SelectedContentReportId" class="form-label">Link to Content Report (Optional)</label>
                                    <select asp-for="FarewellPerson.SelectedContentReportId" class="form-select">
                                        <option value="">No content report linked</option>
                                        @foreach (var report in Model.AllContentReports)
                                        {
                                            <option value="@report.Id">@report.Reason - @report.Email (@report.CreatedAt.ToString("yyyy-MM-dd HH:mm"))</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Admin Action Log</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="FarewellPerson.Action" class="form-label">Action Type</label>
                                        <select asp-for="FarewellPerson.Action" class="form-select">
                                            <option value="edit">Edit</option>
                                            <option value="delete">Delete</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="FarewellPerson.ActionReason" class="form-label">Reason *</label>
                                        <input asp-for="FarewellPerson.ActionReason" class="form-control" placeholder="e.g., content_update, policy_violation" required />
                                        <span asp-validation-for="FarewellPerson.ActionReason" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="FarewellPerson.ActionDetails" class="form-label">Details *</label>
                                    <textarea asp-for="FarewellPerson.ActionDetails" class="form-control" rows="3" placeholder="Provide additional details about this action..." required></textarea>
                                    <span asp-validation-for="FarewellPerson.ActionDetails" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="@Url.Action("FarewellPeople")" class="btn btn-secondary">Cancel</a>
                            <div>
                                <button type="submit" name="saveButton" value="save" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete Person</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Information</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Created:</strong> @Model.FarewellPerson.CreatedAt.ToString("yyyy-MM-dd HH:mm")</p>
                            <p><strong>Last Updated:</strong> @Model.FarewellPerson.UpdatedAt.ToString("yyyy-MM-dd HH:mm")</p>
                            <p><strong>Related Messages:</strong> @Model.RelatedMessages.Count</p>
                            
                            @if (Model.AllContentReports.Any())
                            {
                                <p><strong>Related Content Reports:</strong> @Model.AllContentReports.Count</p>
                                <div class="mt-3">
                                    <h6>Recent Reports:</h6>
                                    @foreach (var report in Model.AllContentReports.Take(3))
                                    {
                                        <div class="border-bottom pb-2 mb-2">
                                            <small>@report.Reason - @report.CreatedAt.ToString("yyyy-MM-dd HH:mm")</small>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                    
                    @if (Model.RelatedMessages.Any())
                    {
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Related Messages</h5>
                            </div>
                            <div class="card-body">
                                @foreach (var message in Model.RelatedMessages.Take(5))
                                {
                                    <div class="border-bottom pb-2 mb-2">
                                        <small>@(message.Message.Length > 50 ? message.Message.Substring(0, 50) + "..." : message.Message)</small>
                                        <br><small class="text-muted">@message.CreatedAt.ToString("yyyy-MM-dd")</small>
                                    </div>
                                }
                                @if (Model.RelatedMessages.Count > 5)
                                {
                                    <a href="@Url.Action("FarewellMessages")" class="btn btn-sm btn-outline-primary w-100">View All Messages</a>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "@Model.FarewellPerson.Name"?</p>
                <p class="text-danger">This action cannot be undone and will also delete all associated messages.</p>
                
                <div class="mb-3">
                    <label for="deleteReason" class="form-label">Delete Reason (Required)</label>
                    <input type="text" id="deleteReason" name="deleteReason" class="form-control" required />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" name="saveButton" value="delete" class="btn btn-danger">Confirm Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const deleteModal = document.getElementById('deleteModal');
            const deleteForm = deleteModal.querySelector('form') || document.querySelector('form');
            
            deleteModal.addEventListener('shown.bs.modal', function () {
                document.getElementById('deleteReason').focus();
            });
            
            // Handle delete confirmation
            const deleteButton = document.querySelector('button[value="delete"]');
            if (deleteButton) {
                deleteButton.addEventListener('click', function(e) {
                    const reason = document.getElementById('deleteReason').value.trim();
                    if (!reason) {
                        e.preventDefault();
                        alert('Please provide a delete reason.');
                        return;
                    }
                    
                    // Set the delete confirmation flag
                    const deleteInput = document.createElement('input');
                    deleteInput.type = 'hidden';
                    deleteInput.name = 'isDeleteConfirmed';
                    deleteInput.value = 'true';
                    deleteForm.appendChild(deleteInput);
                    
                    // Add delete reason to the form
                    const reasonInput = document.createElement('input');
                    reasonInput.type = 'hidden';
                    reasonInput.name = 'FarewellPerson.ActionReason';
                    reasonInput.value = reason;
                    deleteForm.appendChild(reasonInput);
                });
            }
        });
    </script>
}